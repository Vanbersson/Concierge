<div class="layout-card">
    <!-- Info -->
    <p-toast />
    <div class="layout-card-title">
        <span>Entrada de veículos</span>
        <div class="layout-button-alert">
            @if (listVehicleEntry.length > 0) {
                <p-badge [value]="listVehicleEntry.length" severity="warning"></p-badge>
                <p-button type="button" icon="pi pi-car" [rounded]="true" severity="warning" [outlined]="true" [text]="true" size="large" (onClick)="showDialogVehicle()" />
            }
        </div>
    </div>

    <p-stepper #stepper [(activeStep)]="activeStepper">
        <!-- client -->
        <p-stepperPanel>
            <ng-template pTemplate="header" let-onClick="onClick" let-index="index">
                <button class="bg-transparent border-none inline-flex flex-column gap-2" (click)="stepperClientCompany()">
                    <span
                        class="border-round border-1 w-3rem h-3rem inline-flex align-items-center justify-content-center"
                        [ngClass]="{'bg-primary border-primary': index <= activeStepper, 'surface-border': index > activeStepper}">
                        <i class="pi pi-building"></i>
                    </span>
                </button>
            </ng-template>
            <ng-template pTemplate="content" let-nextCallback="nextCallback">
                <form [formGroup]="formClientCompany" class="layout-card-step">
                    <span>Vamos fazer a entrada de um novo veículo</span>
                    <p>
                        Por favor selecione a empresa em que esse veículo pertence.
                    </p>
                    <div class="p-fluid p-formgrid grid">
                        <div class="col-12 flex align-items-center gap-2">
                            <p-checkbox inputId="ClientCompanyNotId" value="not" formControlName="clientCompanyNot" (click)="validationClientCompany()" />
                            <div class="checkboxDisable"> </div>
                            <label for="ClientCompanyNotId" style="color: #3B82F6;">Empresa sem cadastro!</label>
                        </div>
                        <div class="col-12 md:col-1">
                            <label for="clientCompanyId">Código</label>
                            <p-inputNumber inputId="clientCompanyId" [useGrouping]="false" formControlName="clientCompanyId" />
                        </div>
                        <div class="md:col-11"></div>
                        <div class="col-10 md:col-6">
                            <label for="clientCompanyName">Empresa</label>
                            <input pInputText id="clientCompanyName" type="text" formControlName="clientCompanyName" [style]="{'text-transform':'uppercase'}" />
                        </div>
                        <div class="col-2 md:col-1 flex flex-column">
                            <label for="">Filtro</label>
                            <app-filterclient (outputClient)="selectClientCompany.set($event)" />
                        </div>
                        <div class="md:col-5"></div>
                        <div class="col-12 md:col-2">
                            <label for="clientCompanyCnpj">CNPJ</label>
                            <p-inputMask id="clientCompanyCnpj" mask="99.999.999/9999-99" formControlName="clientCompanyCnpj" />
                        </div>
                        <div class="col-12 md:col-2">
                            <label for="clientCompanyCpf">CPF</label>
                            <p-inputMask id="clientCompanyCpf" mask="999.999.999-99" formControlName="clientCompanyCpf" />
                        </div>
                        <div class="col-12 md:col-2">
                            <label for="clientCompanyRg">RG</label>
                            <p-inputNumber inputId="clientCompanyRg" [useGrouping]="false" formControlName="clientCompanyRg" />
                        </div>
                        <div class="md:col-6"></div>
                    </div>
                </form>
                <p-divider type="solid" />
                <div class="flex justify-content-end">
                    <p-button (onClick)="nextStepperClientCompany()" label="Avançar" icon="pi pi-arrow-right" iconPos="right" />
                </div>
            </ng-template>
        </p-stepperPanel>
        <!-- Driver -->
        <p-stepperPanel>
            <ng-template pTemplate="header" let-onClick="onClick" let-index="index">
                <button class="bg-transparent border-none inline-flex flex-column gap-2" (click)="stepperDriver()">
                    <span
                        class="border-round border-2 w-3rem h-3rem inline-flex align-items-center justify-content-center"
                        [ngClass]="{
                            'bg-primary border-primary': index <= activeStepper,
                            'surface-border': index > activeStepper
                        }">
                        <i class="pi pi-user"></i>
                    </span>
                </button>
            </ng-template>
            <ng-template pTemplate="content" let-prevCallback="prevCallback" let-nextCallback="nextCallback">
                <form [formGroup]="formDriver" class="layout-card-step">
                    <span>Vamos informar o motorista</span>
                    <p>
                        Por favor selecione o motorista.
                    </p>
                    <div class="p-fluid p-formgrid grid">
                        <div class="col-12 flex align-items-center mt-2">
                            <div class="layout-photo-person">
                                <p-image *ngIf="driverEntryPhoto" [imageStyle]="{'border-radius':'100%','object-fit':'cover','width':'80px','height':'80px'}" [src]="driverEntryPhoto" alt="imagem motorista" [preview]="true" />  
                            </div>
                        </div>
                            <div class="col-12 md:col-1">
                            <label for="driverEntryId">Código</label>
                            <p-inputNumber inputId="driverEntryId" [useGrouping]="false" formControlName="driverEntryId" />
                        </div>
                        <div class="col-10 md:col-6">
                            <label for="driverEntryName">Nome</label>
                            <input pInputText id="driverEntryName" type="text" formControlName="driverEntryName" [style]="{'text-transform':'capitalize'}">
                        </div>
                        <div class="col-2 md:col-1 flex flex-column">
                            <label for="">Filtro</label>
                            <app-filterdriver (outputDriver)="selectDriver.set($event)"/>
                        </div>
                        <div class="md:col-4"></div>
                        <div class="col-12 md:col-3">
                            <label for="driverEntryCpf">CPF</label>
                            <p-inputMask id="driverEntryCpf" mask="999.999.999-99" unmask="true" formControlName="driverEntryCpf" />
                        </div>
                        <div class="col-12 md:col-3">
                            <label for="driverEntryRg">RG</label>
                            <p-inputNumber id="clientCompanyRg" mode="decimal" [useGrouping]="false" formControlName="driverEntryRg" />
                        </div>
                        <div class="md:col-8"></div>
                        <div class="col-12 md:col-6 flex align-items-center gap-2">
                            <div class="layout-file">
                                <div class="layout-file-img">
                                    <p-image *ngIf="driverEntryPhotoDoc1"  [imageStyle]="{'border-radius':'8px','object-fit':'cover'}" [src]="driverEntryPhotoDoc1" alt="" [preview]="true" />
                                </div>
                            </div>
                            <div class="layout-file">
                                <div class="layout-file-img">
                                    <p-image *ngIf="driverEntryPhotoDoc2"  [imageStyle]="{'border-radius':'8px','object-fit':'cover'}" [src]="driverEntryPhotoDoc2" alt="" [preview]="true" />
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                <p-divider type="solid" />
                <div class="flex justify-content-between">
                    <p-button (onClick)="prevCallback.emit()" label="Voltar" severity="secondary" icon="pi pi-arrow-left" />
                    <p-button (onClick)="nextSterpperDriver()" label="Avançar" icon="pi pi-arrow-right"  iconPos="right" />
                </div>
            </ng-template>
        </p-stepperPanel>
        <!-- Vehicle -->
        <p-stepperPanel>
            <ng-template pTemplate="header" let-onClick="onClick" let-index="index">
                <button class="bg-transparent border-none inline-flex flex-column gap-2" (click)="stepperVehicle()">
                    <span
                        class="border-round border-2 w-3rem h-3rem inline-flex align-items-center justify-content-center"
                        [ngClass]="{
                            'bg-primary border-primary': index <= activeStepper,
                            'surface-border': index > activeStepper
                        }">
                        <i class="pi pi-car"></i>
                    </span>
                </button>
            </ng-template>
            <ng-template pTemplate="content" let-prevCallback="prevCallback">
                <form [formGroup]="formVehicle" class="layout-card-step">
                    <span>Vamos informar agora os dados do veículo</span>
                    <div class="p-fluid p-formgrid grid">
                        <div class="col-12 md:col-1">
                            <label for="placa">Placa</label>
                            <p-inputMask id="placa" mask="***-****" [unmask]="true" [style]="{'text-transform':'uppercase'}" formControlName="placa" />
                            <small class="p-error block" *ngIf="formVehicle.get('placa')?.invalid">Campo obrigatório</small>
                        </div>
                        <div class="col-12 md:col-1">
                            <label for="frotaId">Frota</label>
                            <p-inputNumber inputId="frotaId" [useGrouping]="false" maxlength="10" formControlName="frota" />
                        </div>
                        <div class="col-12 md:col-2">
                            <label for="vehiclemodelid">Modelos</label>
                            <p-multiSelect [options]="vehicleModels$ | async" [selectionLimit]="1" placeholder="Selecione" optionLabel="description" formControlName="modelVehicle">
                                <ng-template let-value pTemplate="selectedItems">
                                    <div class="inline-flex align-items-center gap-2" *ngFor="let model of value">
                                        <img *ngIf="model.photo" src="data:image/png;base64,{{model.photo}}" alt="photo vehicle" height="15" width="15"/>
                                        <div>{{ model.description }}</div>
                                    </div>
                                    <div *ngIf="!value || value.length === 0">Selecione</div>
                                </ng-template>
                                <ng-template let-model pTemplate="item">
                                    <div class="flex align-items-center gap-2">
                                        <img *ngIf="model.photo" src="data:image/png;base64,{{model.photo}}" alt="photo vehicle" height="22" width="22"/>
                                        <div>{{ model.description }}</div>
                                    </div>
                                </ng-template>
                            </p-multiSelect>
                            <small class="p-error block" *ngIf="formVehicle.get('modelVehicle')?.invalid">Campo obrigatório</small>
                        </div>
                        <div class="col-12 md:col-2 ">
                            <label for="dateEntry">Data Entrada</label>
                            <p-calendar [showOnFocus]="false" [showIcon]="true" inputId="dateEntry" [showTime]="true" dateFormat="dd/mm/yy" (onInput)="applyDateTimeMask($event)" formControlName="dateEntry"/>
                            <small class="p-error block" *ngIf="formVehicle.get('dateEntry')?.invalid">Campo obrigatório</small>
                        </div>
                        <div class="col-12 md:col-2 ">
                            <label for="datePrevisionExit">Previsão saída</label>
                            <p-calendar [showOnFocus]="false" [showIcon]="true" inputId="datePrevisionExit" [showTime]="true" dateFormat="dd/mm/yy" (onInput)="applyDateTimeMask($event)" formControlName="datePrevisionExit"/>
                        </div>
                        <div class="col-12 md:col-2">
                            <label for="vehiclecolorid">Cor</label>
                            <p-multiSelect id="vehiclecolorid" [options]="cores" optionLabel="color"  [selectionLimit]="1" placeholder="Selecione" [style]="{'text-transform':'capitalize'}" formControlName="color" />
                            <small class="p-error block" *ngIf="formVehicle.get('color')?.invalid">Campo obrigatório</small>
                        </div>
                        <div class="col-12 md:col-2">
                            <label for="kmatual">KM Atual</label>
                            <p-inputNumber inputId="kmatual" [useGrouping]="false" maxlength="10" formControlName="kmEntry" />
                        </div>
                        <div class="col-12 md:col-2">
                            <label for="coneid">Cone</label>
                            <p-inputNumber inputId="coneid" [useGrouping]="false" formControlName="quantityTrafficCone" />
                        </div>
                        <div class="col-12 md:col-2">
                            <label for="extintorid">Extintor</label>
                            <p-inputNumber inputId="extintorid" [useGrouping]="false" formControlName="quantityExtinguisher" />
                        </div>
                        <div class="col-12 md:col-2">
                            <label for="pneuid">Pneu</label>
                            <p-inputNumber inputId="pneuid" [useGrouping]="false" formControlName="quantityTire" />
                        </div>
                        <div class="col-12 md:col-2">
                            <label for="pneurodaid">Pneu c/roda</label>
                            <p-inputNumber inputId="pneurodaid" [useGrouping]="false"  formControlName="quantityTireComplete" />
                        </div>
                        <div class="col-12 md:col-2">
                            <label for="cxferramentaid">Cx ferramenta</label>
                            <p-inputNumber inputId="cxferramentaid" [useGrouping]="false" formControlName="quantityToolBox" />
                        </div>
                        <div class="col-12 md:col-2">
                            <label for="consultorid">Consultor</label>
                            <p-multiSelect id="consultorid" [options]="attendants" [selectionLimit]="1"  optionLabel="name" placeholder="Selecione" [style]="{'text-transform':'capitalize'}" formControlName="UserAttendant" />
                        </div>
                        <div class="col-12 md:col-3">
                            <label for="">Veículo novo</label>
                            <div class="flex align-items-center gap-2 border-1 border-round border-300 p-3">
                                <div class="flex align-items-center">
                                    <p-radioButton inputId="newyes" value="yes" formControlName="vehicleNew" (onClick)="deleteRequirePlaca()"></p-radioButton>
                                    <label for="newyes" class="ml-2">Sim</label>
                                </div>
                                <div class="flex align-items-center">
                                    <p-radioButton inputId="newnot" value="not" formControlName="vehicleNew" (onClick)="addRequirePlaca()"></p-radioButton>
                                    <label for="newnot" class="ml-2">Não</label>
                                </div>
                            </div>
                        </div>
                         <div class="col-12 md:col-3">
                            <label>Ordem serviço</label>
                            <div class="flex align-items-center gap-2 border-1 border-round border-300 p-3">
                                <div class="flex align-items-center">
                                    <p-radioButton inputId="serviceyes" value="yes" formControlName="serviceOrder"></p-radioButton>
                                    <label for="serviceyes" class="ml-2">Sim</label>
                                </div>
                                <div class="flex align-items-center">
                                    <p-radioButton inputId="serviceno" value="not" formControlName="serviceOrder"></p-radioButton>
                                    <label for="serviceno" class="ml-2">Não</label>
                                </div>
                            </div>
                        </div>
                        <div class="md:col-6"></div>
                        <div class="col-12">
                            <label for="informacao" class="ml-2">Informações</label>
                            <textarea pInputTextarea maxlength="255" id="informacao" rows="4" cols="30" formControlName="informationConcierge"></textarea>
                        </div>
                        <div class="col-12 md:col-4 flex justify-content-between gap-1">
                            <div class="layout-file">
                                <div class="layout-file-img">
                                    <p-image *ngIf="photoVehicle1" [imageStyle]="{'object-fit':'cover'}" [src]="photoVehicle1" alt="" [preview]="true"/>
                                </div>
                                <button pButton *ngIf="photoVehicle1" severity="danger" (click)="deleteFileVehicle1()">
                                    <i class="pi pi-trash"></i>
                                    <span>Remover</span>
                                </button>
                                <button pButton *ngIf="!photoVehicle1" type="button" (click)="photoFile1Vehicle()">
                                    <i class="pi pi-plus"></i>
                                    <span>Incluir</span>
                                </button>
                            </div> 
                            <div class="layout-file">
                                <div class="layout-file-img">
                                    <p-image *ngIf="photoVehicle2" [imageStyle]="{'object-fit':'cover'}" [src]="photoVehicle2" alt="" [preview]="true"/>
                                </div>
                                <button *ngIf="photoVehicle2" pButton severity="danger" (click)="deleteFileVehicle2()">
                                    <i class="pi pi-trash"></i>
                                    <span>Remover</span>
                                </button>
                                <button *ngIf="!photoVehicle2" pButton type="button" (click)="photoFile2Vehicle()">
                                    <i class="pi pi-plus"></i>
                                    <span>Incluir</span>
                                </button>
                            </div>
                            <div class="layout-file">
                                <div class="layout-file-img">
                                    <p-image *ngIf="photoVehicle3" [imageStyle]="{'object-fit':'cover'}" [src]="photoVehicle3" alt="" [preview]="true"/>
                                </div>
                                <button *ngIf="photoVehicle3" pButton severity="danger" (click)="deleteFileVehicle3()">
                                    <i class="pi pi-trash"></i>
                                    <span>Remover</span>
                                </button>  
                                <button *ngIf="!photoVehicle3" pButton type="button" (click)="photoFile3Vehicle()">
                                    <i class="pi pi-plus"></i>
                                    <span>Incluir</span>
                                </button>  
                            </div>
                            <div class="layout-file">
                                <div class="layout-file-img">
                                    <p-image *ngIf="photoVehicle4" [imageStyle]="{'object-fit':'cover'}" [src]="photoVehicle4" alt="" [preview]="true"/>
                                </div>
                                <button *ngIf="photoVehicle4" pButton severity="danger" (click)="deleteFileVehicle4()">
                                    <i class="pi pi-trash"></i>
                                    <span>Remover</span>
                                </button>
                                <button *ngIf="!photoVehicle4" pButton type="button" (click)="photoFile4Vehicle()">
                                    <i class="pi pi-plus"></i>
                                    <span>Incluir</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
                <p-divider type="solid" />
                <div class="flex justify-content-start gap-2">
                    <button pButton (click)="prevCallback.emit()" label="Voltar" severity="secondary" icon="pi pi-arrow-left"></button>
                    <button pButton icon="pi pi-plus" label="Adicionar " [outlined]="true" (click)="addVehicleEntry()"></button>
                </div>
            </ng-template>
        </p-stepperPanel>
    </p-stepper>
</div>

<!-- Dialog Veículos -->
<p-dialog header="Lista de veículos" [(visible)]="dialogVehicleVisible" [modal]="true"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }">
    <p-table [value]="listVehicleEntry"  [tableStyle]="{ 'min-width': '60rem' }" styleClass="p-datatable-sm">
        <ng-template pTemplate="header">
            <tr>
                <th pSortableColumn="placa">Placa<p-sortIcon field="placa"></p-sortIcon></th>
                <th pSortableColumn="frota">Frota<p-sortIcon field="frota"></p-sortIcon></th>
                <th pSortableColumn="modelDescription">Modelo<p-sortIcon field="modelDescription"></p-sortIcon></th>
                <th pSortableColumn="nameUserAttendant">Consultor<p-sortIcon field="nameUserAttendant"></p-sortIcon></th>
                <th pSortableColumn="clientCompanyName">Empresa<p-sortIcon field="clientCompanyName"></p-sortIcon></th>
                <th></th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-vehicle let-index="rowIndex">
            <tr>
                <td>
                    @if (vehicle.vehicleNew == "yes") {
                    <p-tag value="NOVO" severity="danger"></p-tag>
                    }@else{
                    <span class="text-500">{{vehicle.placa | uppercase}}</span>
                    }
                </td>
                <td><span class="text-500">{{vehicle.frota}}</span></td>
                <td><span class="text-500">{{vehicle.modelDescription | uppercase}}</span></td>
                @if(vehicle.nameUserAttendant == ""){
                <td><p-tag value="FALTA" severity="danger"></p-tag></td>
                }@else {
                <td><span class="text-500">{{vehicle.nameUserAttendant | uppercase}}</span></td>
                }
                @if(vehicle.clientCompanyName ==""){
                <td> <p-tag value="FALTA" severity="danger"></p-tag> </td>
                }@else {
                <td><span class="text-500">{{ firstSecondaryName(vehicle.clientCompanyName)  | uppercase }}</span></td>
                }
                <td>
                    <button pButton [text]="true" icon="pi pi-trash" severity="danger" (click)="deleteVehicleEntry(index)"></button>
                </td>
            </tr>
        </ng-template>
    </p-table>
    <div class="flex justify-content-end mt-3">
        <button pButton type="submit" pRipple label="Finalizar" icon="pi pi-check" class="p-button-text"  (click)="saveVehicleEntry()"></button>
    </div>
</p-dialog>
