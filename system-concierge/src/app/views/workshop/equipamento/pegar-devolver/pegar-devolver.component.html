<div class="layout-card">
    <p-toast />
    <div class="layout-card-title">
        <span>Equipamentos</span>
        <div class="flex gap-2">
            <p-button icon="pi pi-plus" [text]="true" label="Empréstimo" (onClick)="showDialog()" />
            <p-button icon="pi pi-reply" label="Devolver" severity="danger" [disabled]="selectedMaterials.length == 0"
                (onClick)=" listReq()" />
        </div>
    </div>
    <p-table #dt dataKey="mecId" [value]="listfilterMec" [expandedRowKeys]="expandedRows"
        (onRowExpand)="onRowExpand($event)" (onRowCollapse)="onRowCollapse($event)" [paginator]="true" [rows]="10"
        [rowsPerPageOptions]="[10, 25, 50]" [globalFilterFields]="['mecName']" [tableStyle]="{ 'min-width': '50rem' }"
        styleClass="p-datatable-sm">
        <ng-template pTemplate="caption">
            <div class="flex justify-content-between">
                <p-iconField iconPosition="left">
                    <p-inputIcon>
                        <i class="pi pi-search"></i>
                    </p-inputIcon>
                    <input pInputText type="text" (input)="dt.filterGlobal($event.target.value, 'contains')"
                        placeholder="Pesquisar mecânico" />
                </p-iconField>
            </div>
        </ng-template>
        <ng-template pTemplate="header">
            <tr>
                <th style="width: 5%"></th>
                <th class="font-normal" style="width: 5%"></th>
                <th pSortableColumn="mecName" class="font-normal" style="width: 90%">Mecânicos<p-sortIcon
                        field="mecName" /></th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-mec let-expanded="expanded">
            <tr>
                <td>
                    <p-button type="button" pRipple [pRowToggler]="mec" [text]="true" [rounded]="true" size="small"
                        [plain]="true" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
                </td>
                <td>
                    <img class="layout-img-small" src="data:image/png;base64,{{mec.mecPhoto}}" alt="photo mechanic"
                        width="50" height="50" loading="lazy" />
                </td>
                <td class="font-bold text-lg">{{mec.mecName | titlecase}}</td>
            </tr>
        </ng-template>
        <ng-template pTemplate="rowexpansion" let-mec>
            <tr>
                <td colspan="7">
                    <div class="p-3">
                        <p-table #dt1 [value]="mec.materials" dataKey="matMecId" [(selection)]="selectedMaterials"
                            styleClass="p-datatable-sm">
                            <ng-template pTemplate="header">
            <tr>
                <th><p-tableHeaderCheckbox /></th>
                <th class="font-normal" style="width: 10%">Requisição</th>
                <th class="font-normal" style="width: 10%">Entregue</th>
                <th class="font-normal" style="width: 10%">Categoria</th>
                <th class="font-normal" style="width: 10%">Foto</th>
                <th class="font-normal" style="width: 30%">Descrição</th>
                <th class="font-normal" style="width: 10%">Quant.</th>
                <th class="font-normal" style="width: 10%">Inf.</th>
                <th class="font-normal" style="width: 10%">Ver</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-mat>
            <tr>
                <td>
                    <p-tableCheckbox [value]="mat" />
                </td>
                <td>{{mat.requestId}}</td>
                <td>{{mat.requestDateReq | date:'dd/MM/yyyy'}}</td>
                <td>{{mat.categoryDesc | uppercase}}</td>
                <td><img class="layout-img-small" src="data:image/png;base64,{{mat.materialPhoto}}" alt="photo material"
                        width="42" height="42" loading="lazy" /></td>
                <td>{{mat.materialDesc | uppercase}}</td>
                <td>{{mat.materialQuantReq}}</td>
                <td>{{mat.materialInfReq | uppercase}}</td>
                <td><p-button icon="pi pi-book" [rounded]="true" [text]="true" severity="secondary" /></td>
            </tr>
        </ng-template>
    </p-table>
</div>
</td>
</tr>
</ng-template>
</p-table>
</div>

<!-- Pegar -->
<p-dialog header="Empréstimo de Material" [(visible)]="visibleDialogPegar" modal="true"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }" [style]="{width: '46rem', height:'60rem'}">
    <form [formGroup]="formPegar">
        <div class="mt-2 layout-dialog-img">
            <img *ngIf="photoMec" class="layout-img-large" src="data:image/png;base64,{{photoMec}}" loading="lazy" />
        </div>
        <div class="p-fluid p-formgrid grid">
            <div class="field col-12 md:col-6 p-1">
                <label for="mechanicId">Mecânicos</label>
                <p-multiSelect [options]="listMec" display="chip" [selectionLimit]="1" placeholder="Selecione"
                    optionLabel="name" formControlName="mechanic" (onChange)="selectMechanic()"
                    [style]="{height:'45.5px'}">
                    <ng-template let-value pTemplate="selectedItems">
                        <div class="inline-flex align-items-center gap-2" *ngFor="let mec of value">

                            @if(mec.photo){
                            <img class="layout-img-small" [src]="'data:image/png;base64,'+mec.photo" alt="" height="32"
                                width="32" />
                            }
                            <div style="margin: 0.42rem;">{{ mec.name | uppercase }}</div>
                        </div>
                        <div *ngIf="!value || value.length === 0">Selecione</div>
                    </ng-template>
                    <ng-template let-mec pTemplate="item">
                        <div class="flex align-items-center gap-2">
                            @if(mec.photo){
                            <img class="layout-img-small" [src]="'data:image/png;base64,'+mec.photo" alt="" height="32"
                                width="32" />
                            }
                            <div>{{ mec.name | uppercase}}</div>
                        </div>
                    </ng-template>
                </p-multiSelect>
                <small class="p-error block" *ngIf="formPegar.get('mechanic')?.invalid">Campo obrigatório</small>
            </div>
            <div class="field col-12 md:col-6 p-1">
                <label for="categoryId">Categoria</label>
                <p-multiSelect [options]="listCat" optionLabel="description" placeholder="Categorias" display="chip"
                    [selectionLimit]="1" formControlName="categories" (onChange)="selectCategory()"
                    [style]="{height:'45.5px'}" />
                <small class="p-error block" *ngIf="formPegar.get('categories')?.invalid">Campo obrigatório</small>
            </div>
            <div class="field col-12 p-0">
                <label for="mechanicId">Materiais</label>
                <p-multiSelect [options]="listMatTemp" display="chip" [selectionLimit]="5" placeholder="Selecione"
                    optionLabel="description" formControlName="material" (onChange)="selectMaterial()"
                    [style]="{height:'45.5px'}">
                    <ng-template let-value pTemplate="selectedItems">
                        <div class="inline-flex align-items-center gap-2" *ngFor="let mat of value">
                            <img *ngIf="mat.photo" class="layout-img-small" [src]="'data:image/png;base64,'+mat.photo"
                                height="32" width="32" />
                            <div style="margin: 0.42rem;">{{ mat.description | uppercase }}</div>
                        </div>
                        <div *ngIf="!value || value.length === 0">Selecione</div>
                    </ng-template>
                    <ng-template let-mat pTemplate="item">
                        <div class="flex align-items-center gap-2">
                            <img *ngIf="mat.photo" class="layout-img-small" [src]="'data:image/png;base64,'+mat.photo"
                                height="32" width="32" />
                            <div>{{ mat.description | uppercase}}</div>
                            <div class="font-bold"> - {{mat.quantityAvailableLoan}}</div>
                        </div>
                    </ng-template>
                </p-multiSelect>
                <small class="p-error block" *ngIf="formPegar.get('material')?.invalid">Campo obrigatório</small>
            </div>
            <div class="field col-12 p-0" style="height: 280px;">
                <p-table [value]="formPegar.get('material').value" styleClass="p-datatable-sm">
                    <ng-template pTemplate="header">
                        <tr>
                            <th class="font-normal" style="width:10%">Código</th>
                            <th class="font-normal" style="width:10%">Foto</th>
                            <th class="font-normal" style="width:70%">Descrição</th>
                            <th class="font-normal" style="width:10%">Quant.</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-mat>
                        <tr>
                            <td>{{mat.id}}</td>
                            <td>
                                <img *ngIf="mat.photo" class="layout-img-small"
                                    src="data:image/png;base64,{{mat.photo}}" [alt]="mat.description" width="32"
                                    height="32" loading="lazy" />
                            </td>
                            <td>{{mat.description | uppercase}}</td>
                            <td>{{quantityReqDefault}}</td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </div>
        <div class="flex justify-content-between mt-1">
            <p-button icon="pi pi-info-circle" (onClick)="showDialogInf()" />
            <div class="gap-2">
                <button pButton type="button" pRipple label="Fechar" icon="pi pi-times" class="p-button-text"
                    (click)=" hideDialog()"></button>
                <button pButton type="button" pRipple label="Confirmar" icon="pi pi-check" class="p-button-text"
                    [disabled]="formPegar.get('material').invalid" (click)="confirm()"></button>
            </div>
        </div>
    </form>
</p-dialog>

<!-- Dialog info -->
<p-dialog header="Informações" [(visible)]="visibleDialogPegarInf" modal="true"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }" [style]="{width: '40rem', height:'20rem'}">
    <form [formGroup]="formPegar">
        <div class="p-fluid p-formgrid grid">
            <div class="field col-12">
                <textarea rows="5" cols="30" pInputTextarea formControlName="inforReq"></textarea>
            </div>
        </div>
    </form>
    <div class="flex justify-content-center">
        <button pButton type="button" pRipple label="Fechar" icon="pi pi-times" class="p-button-text"
            (click)="hideDialogInf()"></button>
    </div>
</p-dialog>

<p-dialog header="Devolver Materiais" [(visible)]="visibleDialogDev" modal="true"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }" [style]="{width: '60rem', height:'40rem'}">
    <div style="min-height: 30rem;">
        <p-table [value]="listDev"  [tableStyle]="{ 'min-width': '40rem'}" [tableStyle]="{ 'min-width': '50rem' }">
            <ng-template pTemplate="header">
                <tr>
                   
                    <th class="font-normal" style="width: 10%">Querisição</th>
                    <th class="font-normal" style="width: 40%">Mecânico</th>
                    <th class="font-normal" style="width: 10%">Categoria</th>
                    <th class="font-normal" style="width: 40%">Material</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-mat>
                <tr>
                    <td>{{mat.requestId}}</td>
                    <td class="flex align-items-center gap-2"> 
                       <img class="layout-img-small" src="data:image/png;base64,{{mat.mecPhoto}}" alt="photo material" width="42" height="42" loading="lazy" /> {{mat.mecName | uppercase}}
                    </td>
                    <td>{{mat.categoryDesc | uppercase}}</td>
                    <td class="flex align-items-center gap-2">
                        <img class="layout-img-small" src="data:image/png;base64,{{mat.materialPhoto}}" alt="photo material" width="42" height="42" loading="lazy" /> {{mat.materialDesc | uppercase}}
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <div class="flex justify-content-center">
        <button pButton type="button" pRipple label="Confirmar devolução" icon="pi pi-check" class="p-button-text"></button>
    </div>
</p-dialog>

<!-- Comfirm -->
<p-confirmDialog #cd>
    <ng-template pTemplate="headless" let-message>
        <div class="flex flex-column align-items-center p-5 surface-overlay border-round">
            <div class="border-circle bg-primary inline-flex justify-content-center align-items-center h-6rem w-6rem">
                <i class="pi pi-lock text-5xl"></i>
            </div>
            <span class="font-bold text-2xl block mb-2 mt-4">
                {{ message.header }}
            </span>
            <p class="mb-0">{{ message.message }}</p>
            <div class="mt-2 flex">
                <input type="password" pInputText [style]="{height:'60px'}" [(ngModel)]="codePass" />
            </div>
            <div class="flex align-items-center gap-2 mt-4">
                <button pButton label="Confirmar" (click)="cd.accept()" class="w-8rem">
                </button>
                <button pButton label="Cancelar" (click)="cd.reject()" class="p-button-outlined w-8rem ">
                </button>
            </div>
        </div>
    </ng-template>
</p-confirmDialog>