<div class="layout-card">
    <p-toast />
    <div class="layout-card-title">
        <span>Equipamentos</span>
        <div class="flex gap-2">
            <p-button icon="pi pi-plus" [text]="true" label="Empréstimo" (onClick)="showDialog()" />
            <p-button icon="pi pi-reply" label="Devolver" severity="danger" [disabled]="selectedMaterials.length == 0"
                (onClick)=" returnMaterial()" />
        </div>
    </div>
    <p-table #dt dataKey="mecId" [value]="listfilterMec" [expandedRowKeys]="expandedRows"
        (onRowExpand)="onRowExpand($event)" (onRowCollapse)="onRowCollapse($event)" [paginator]="true" [rows]="10"
        [rowsPerPageOptions]="[10, 25, 50]" [globalFilterFields]="['mecName']" [tableStyle]="{ 'min-width': '50rem' }"
        styleClass="p-datatable-sm">
        <ng-template pTemplate="caption">
            <div class="flex justify-content-between">
                <p-iconField iconPosition="left">
                    <p-inputIcon>
                        <i class="pi pi-search"></i>
                    </p-inputIcon>
                    <input pInputText type="text" (input)="dt.filterGlobal($event.target.value, 'contains')"
                        placeholder="Pesquisar mecânico" />
                </p-iconField>
            </div>
        </ng-template>
        <ng-template pTemplate="header">
            <tr>
                <th style="width: 5%"></th>
                <th class="font-normal" style="width: 5%"></th>
                <th pSortableColumn="mecName" class="font-normal" style="width: 90%">Mecânicos<p-sortIcon
                        field="mecName" /></th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-mec let-expanded="expanded">
            <tr>
                <td>
                    <p-button type="button" pRipple [pRowToggler]="mec" [text]="true" [rounded]="true" size="small" [plain]="true" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
                </td>
                <td>
                    <img class="layout-img-small" src="data:image/png;base64,{{mec.mechanic.photo}}" alt="photo mechanic" width="50" height="50" loading="lazy" />
                </td>
                <td class="font-bold text-lg">{{mec.mechanic.name | titlecase}}</td>
            </tr>
        </ng-template>
         <ng-template pTemplate="rowexpansion" let-mec>
            <tr>
                <td colspan="7">
                    <div class="p-3">
                        <p-table #dt1 [value]="mec.materials" dataKey="matMecId" [(selection)]="selectedMaterials"
                            styleClass="p-datatable-sm">
                            <ng-template pTemplate="header">
                                <tr>
                                    <th></th>
                                    <th pSortableColumn="requestId" class="font-normal" style="width: 10%">Requisição<p-sortIcon field="requestId"></p-sortIcon></th>
                                    <th pSortableColumn="requestDate" class="font-normal" style="width: 10%">Entregue<p-sortIcon field="requestDate"></p-sortIcon></th>
                                    <th pSortableColumn="categoryDesc" class="font-normal" style="width: 10%">Categoria<p-sortIcon field="categoryDesc"></p-sortIcon></th>
                                    <th pSortableColumn="materialPhoto" class="font-normal" style="width: 10%">Foto<p-sortIcon field="materialPhoto"></p-sortIcon></th>
                                    <th pSortableColumn="materialDesc" class="font-normal" style="width: 30%">Descrição<p-sortIcon field="materialDesc"></p-sortIcon></th>
                                    <th pSortableColumn="materialQuantReq" class="font-normal" style="width: 10%">Quant.<p-sortIcon field="materialQuantReq"></p-sortIcon></th>
                                    <th pSortableColumn="requestInf" class="font-normal" style="width: 10%">Inf.<p-sortIcon field="requestInf"></p-sortIcon></th>
                                    <th class="font-normal" style="width: 10%">Ver</th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-mat>
                                <tr *ngIf="!mat.matMecDateRet">
                                    <td>
                                        <p-tableCheckbox [value]="mat" />
                                    </td>
                                    <td>{{mat.requestId}}</td>
                                    <td>{{mat.requestDate | date:'dd/MM/yyyy'}}</td>
                                     <td>{{mat.categoryDesc | uppercase}}</td>
                                    <td><img class="layout-img-small" src="data:image/png;base64,{{mat.materialPhoto}}" alt="photo material" width="42" height="42" loading="lazy" /></td>
                                    <td>{{mat.materialDesc | uppercase}}</td>
                                    <td>{{mat.matMecQuantityReq | number:'1.2-2'}}</td>
                                    <td>{{mat.requestInformation | uppercase}}</td>
                                    <td><p-button icon="pi pi-book" [rounded]="true" [text]="true" severity="secondary" /></td> 
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>
                </td>
            </tr>
        </ng-template> 
    </p-table>
</div>

<!-- Pegar -->
<p-dialog header="Empréstimo de Material" [(visible)]="visibleDialogPegar" modal="true"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }" [style]="{width: '46rem', height:'60rem'}">
    <form [formGroup]="formPegar">
        <div class="mt-2 layout-dialog-img">
            <img *ngIf="photoMec" class="layout-img-large" src="data:image/png;base64,{{photoMec}}" loading="lazy" />
        </div>
        <div class="p-fluid p-formgrid grid">
            <div class="field col-12 md:col-6 p-1">
                <label for="mechanicId">Mecânicos</label>
                <p-multiSelect [options]="listMec" display="chip" [selectionLimit]="1" placeholder="Selecione"
                    optionLabel="name" formControlName="mechanic" (onChange)="selectMechanic()"
                    [style]="{height:'45.5px'}">
                    <ng-template let-value pTemplate="selectedItems">
                        <div class="inline-flex align-items-center gap-2" *ngFor="let mec of value">

                            @if(mec.photo){
                            <img class="layout-img-small" [src]="'data:image/png;base64,'+mec.photo" alt="" height="32"
                                width="32" />
                            }
                            <div style="margin: 0.42rem;">{{ mec.name | uppercase }}</div>
                        </div>
                        <div *ngIf="!value || value.length === 0">Selecione</div>
                    </ng-template>
                    <ng-template let-mec pTemplate="item">
                        <div class="flex align-items-center gap-2">
                            @if(mec.photo){
                            <img class="layout-img-small" [src]="'data:image/png;base64,'+mec.photo" alt="" height="32"
                                width="32" />
                            }
                            <div>{{ mec.name | uppercase}}</div>
                        </div>
                    </ng-template>
                </p-multiSelect>
                <small class="p-error block" *ngIf="formPegar.get('mechanic')?.invalid">Campo obrigatório</small>
            </div>
            <div class="field col-12 md:col-6 p-1">
                <label for="categoryId">Categoria</label>
                <p-multiSelect [options]="listCat" optionLabel="description" placeholder="Categorias" display="chip"
                    [selectionLimit]="1" formControlName="categories" (onChange)="selectCategory()"
                    [style]="{height:'45.5px'}" />
                <small class="p-error block" *ngIf="formPegar.get('categories')?.invalid">Campo obrigatório</small>
            </div>
            <div class="field col-12 p-0">
                <label for="mechanicId">Materiais</label>
                <p-multiSelect [options]="listMatTemp" (onChange)="selectMaterial()" display="chip" [disabled]="disabledSelectMat"
                    [selectionLimit]="quantitySelectDefaultMat()" placeholder="Selecione" optionLabel="description"
                    formControlName="material" [style]="{height:'45.5px'}">
                    <ng-template let-value pTemplate="selectedItems">
                        <div class="inline-flex align-items-center gap-2" *ngFor="let mat of value">
                            <img *ngIf="mat.photo" class="layout-img-small" [src]="'data:image/png;base64,'+mat.photo" height="32" width="32" />
                            <div style="margin: 0.42rem;">{{ mat.description | uppercase }}</div>
                        </div>
                        <div *ngIf="!value || value.length === 0">Selecione</div>
                    </ng-template>
                    <ng-template let-mat pTemplate="item">
                        <div class="flex align-items-center gap-2">
                            <img *ngIf="mat.photo" class="layout-img-small" [src]="'data:image/png;base64,'+mat.photo" height="32" width="32" />
                            <div>{{ mat.description | uppercase}}</div>
                            <div class="font-bold"> - {{mat.quantityAvailableLoan}}</div>
                        </div>
                    </ng-template>
                </p-multiSelect>
                <small class="p-error block" *ngIf="formPegar.get('material')?.invalid">Campo obrigatório</small>
            </div>
            
        </div>
        
    </form>
    <div class="field col-12 p-0" style="height: 280px;">
        <p-table [value]="formPegar.get('material').value" dataKey="id" editMode="row" [scrollable]="true" scrollHeight="280px"
            styleClass="p-datatable-sm">
            <ng-template pTemplate="header">
                <tr>
                    <th class="font-normal" style="width:10%">Código</th>
                    <th class="font-normal" style="width:10%">Foto</th>
                    <th class="font-normal" style="width:50%">Descrição</th>
                    <th class="font-normal" style="width:20%">Quant.</th>
                    <th class="font-normal" style="width:10%"></th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-mat let-editing="editing" let-ri="rowIndex">
                <tr [pEditableRow]="mat">
                    <td>{{mat.id}}</td>
                    <td>
                        <img *ngIf="mat.photo" class="layout-img-small" src="data:image/png;base64,{{mat.photo}}" [alt]="mat.description" width="32" height="32" loading="lazy" />
                    </td>
                    <td>{{mat.description | uppercase}}</td>
                    <td>
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <p-inputNumber model="decimal" [useGrouping]="false" [(ngModel)]="mat.quantityLoan"/>
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{mat.quantityLoan | number:'1.2-2'}}
                            </ng-template>
                        </p-cellEditor>
                    </td>
                    <td *ngIf="formPegar.get('categories').value.at(0).type == UNIFORME">
                        <div class="flex align-items-center justify-content-center gap-2">
                            <button 
                                *ngIf="!editing" 
                                pButton 
                                pRipple 
                                type="button" 
                                pInitEditableRow 
                                icon="pi pi-pencil" 
                                (click)="onRowEditInit(mat)" 
                                class="p-button-rounded p-button-text">
                            </button>
                            <button 
                                *ngIf="editing" 
                                pButton 
                                pRipple 
                                type="button" 
                                pSaveEditableRow 
                                icon="pi pi-check" 
                                (click)="onRowEditSave(mat)" 
                                class="p-button-rounded p-button-text p-button-success mr-1">
                            </button>
                            <button 
                                *ngIf="editing" 
                                pButton pRipple 
                                type="button" 
                                pCancelEditableRow 
                                icon="pi pi-times" 
                                (click)="onRowEditCancel(mat, ri)" 
                                class="p-button-rounded p-button-text p-button-danger">
                            </button>
                        </div>
                    </td>
                    <td *ngIf="formPegar.get('categories').value.at(0).type != UNIFORME"></td>
                </tr>
            </ng-template>
        </p-table>
    </div>
    <div class="flex justify-content-between mt-1">
        <p-button icon="pi pi-info-circle" (onClick)="showDialogInf()" />
        <div class="gap-2">
            <button pButton type="button" pRipple label="Fechar" icon="pi pi-times" class="p-button-text"
                (click)=" hideDialog()"></button>
            <button pButton type="button" pRipple label="Confirmar" icon="pi pi-check" class="p-button-text"
                [disabled]="formPegar.get('material').invalid" (click)="confirm()"></button>
        </div>
    </div>
</p-dialog>

<!-- Dialog info -->
<p-dialog header="Informações" [(visible)]="visibleDialogPegarInf" modal="true"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }" [style]="{width: '40rem', height:'20rem'}">
    <form [formGroup]="formPegar">
        <div class="p-fluid p-formgrid grid">
            <div class="field col-12">
                <textarea rows="5" cols="30" pInputTextarea formControlName="inforReq"></textarea>
            </div>
        </div>
    </form>
    <div class="flex justify-content-center">
        <button pButton type="button" pRipple label="Fechar" icon="pi pi-times" class="p-button-text" (click)="hideDialogInf()"></button>
    </div>
</p-dialog>

<!-- Retorno de material -->
<p-dialog header="Devolver Materiais" [(visible)]="visibleDialogDev" modal="true" closable="false"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }" [style]="{width: '80rem', height:'40rem'}">
    <div style="min-height: 30rem;">
        <p-table [value]="listReturnMaterial" [tableStyle]="{ 'min-width': '40rem'}" [tableStyle]="{ 'min-width': '50rem' }">
            <ng-template pTemplate="header">
                <tr>
                    <th class="font-normal" style="width: 10%">Requisição</th>
                    <th class="font-normal" style="width: 35%">Mecânico</th>
                    <th class="font-normal" style="width: 10%">Categoria</th>
                    <th class="font-normal" style="width: 5%">Quantidade</th>
                    <th class="font-normal" style="width: 40%">Material</th>
                    <th class="font-normal" style="width: 10%">Inf</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-mat>
                <tr>
                    <td>{{mat.requestId}}</td>
                    <td class="flex align-items-center gap-2">
                        <img *ngIf="mat.mechanic.photo" class="layout-img-small" src="data:image/png;base64,{{mat.mechanic.photo}}" alt="photo material" width="42" height="42" loading="lazy" /> {{mat.mechanic.name | uppercase}}
                    </td>
                    <td>{{mat.categoryDesc | uppercase}}</td>
                    <td>{{mat.matMecQuantityReq}}</td>
                    <td class="flex align-items-center gap-2">
                        <img *ngIf="mat.materialPhoto" class="layout-img-small" src="data:image/png;base64,{{mat.materialPhoto}}" alt="photo material" width="42" height="42" loading="lazy" /> {{mat.materialDesc | uppercase}}
                    </td>
                    <td><input pInputText type="text" [(ngModel)]="mat.matMecInformationRet"/></td>
                </tr>
            </ng-template>
        </p-table>
    </div>
    <div class="flex justify-content-end">
        <button pButton type="button" pRipple label="Fechar" icon="pi pi-times" class="p-button-text" (click)=" hideDialogDev()"></button>
        <button pButton type="button" pRipple label="Confirmar" icon="pi pi-check" class="p-button-text" (click)="confirmReturnMaterial()"></button>
    </div>
</p-dialog>

<!-- Confirm password mechanic -->
<p-confirmDialog #dv key="confimMecCodePass">
    <ng-template pTemplate="headless" let-message>
        <div class="flex flex-column align-items-center p-5 surface-overlay border-round">
             <span class="font-bold text-2xl block mb-2 mt-4">
                {{ message.header }}
            </span>
            <div class="mt-2 layout-dialog-img">
                <img *ngIf="photoMecDev"  class="layout-img-large" src="data:image/png;base64,{{photoMecDev}}" loading="lazy" />
            </div>
            <span class="font-bold text-2xl block mb-2">
                {{ message.message }}
            </span>
            <p class="mb-0">Por favor digite sua senha.</p>
            <div class="mt-2 flex">
                <form [formGroup]="formCodePass" (ngSubmit)="onConfirmCodePass(dv)">
                     <input pInputText id="maskedPassword" type="text" formControlName="maskedPassword" (input)="onInput()" autocomplete="off" [style]="{'height':'60px'}"/>
                </form>
            </div>
            <div class="flex align-items-center gap-2 mt-4">
                <button pButton type="button" label="Confirmar" (click)="onConfirmCodePass(dv)" class="w-8rem">
                </button>
                <button pButton label="Cancelar" (click)="dv.reject()" class="p-button-outlined w-8rem ">
                </button>
            </div>
        </div>
    </ng-template>
</p-confirmDialog>

<!-- Comfirm -->
<p-confirmDialog #cd>
    <ng-template pTemplate="headless" let-message>
        <div class="flex flex-column align-items-center p-5 surface-overlay border-round">
            <div class="border-circle bg-primary inline-flex justify-content-center align-items-center h-6rem w-6rem">
                <i class="pi pi-lock text-5xl"></i>
            </div>
            <span class="font-bold text-2xl block mb-2 mt-4">
                {{ message.header }}
            </span>
            <p class="mb-0">{{ message.message }}</p>
            <div class="mt-2 flex">
                <form [formGroup]="formCodePass" (ngSubmit)="cd.accept()">
                    <input pInputText id="maskedPassword" type="text" formControlName="maskedPassword" (input)="onInput()" autocomplete="off" [style]="{'height':'60px'}"/>
                </form>
            </div>
            <div class="flex align-items-center gap-2 mt-4">
                <button pButton type="submit" label="Confirmar" (click)="cd.accept()" class="w-8rem">
                </button>
                <button pButton label="Cancelar" (click)="cd.reject()" class="p-button-outlined w-8rem ">
                </button>
            </div>
        </div>
    </ng-template>
</p-confirmDialog>